<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="bootstrap.min.css" rel="stylesheet">


    <title>Document</title>
    <script>
        window.addEventListener("load", initialize);

        var doctors;
        var appointments;
        var Valid = "lightgreen";
        var Invalid = "pink";
        var Initial = "white"
        // const time=[];
        const resTime=[];
        const time = [];

        let nameValidation = false;
        let mobileValidation = false;
        let emailValidation = false;
        let dateValidation = true;
        let timeValidation = true;
        let doctorValidation = false;

        let oldAppointment = null;
        let appointment = null;
        var baseurl = "http://"+location.hostname+"/appointment_R/server/";
        var mod = function (data) {

            var confirm = window.confirm("Are you sure to modify this appointment " + data.name + "  ?");
            if (confirm) {
                fillForm(data);
                btnAdd.setAttribute("disabled", "disabled");
            }
        }



        function Appointment(name, mobile,email, date,time, doctor) {
            this.name = name;
            this.mobile = mobile;
            this.email = email;
            this.date = date;
            this.time = time;
            this.doctor = doctor;
        }

        function initialize() {

            doctors = get("doctorcontroller.php");

            loadView();
            loadForm();
            // btnClear.addEventListener("click", clearForm);
            btnAdd.addEventListener("click", Add);
            // btnTime.addEventListener("click", genarateTime);
            btnAdd.removeAttribute("disabled", "disabled");
            txtName.addEventListener("input", txtNameKU);
            txtMobile.addEventListener("input", txtMobileKU);
            txtEmail.addEventListener("input", txtEmailKU);
            cmbDoctor.addEventListener("change", cmbDoctorCH); //Arrow function like annonymous function.
            // loadTime();
        }

         function loadView() {

         }

        function loadForm() {
            doctors = get("doctorcontroller.php");
            //fillForm(data);
            FillCombo(doctors, cmbDoctor);
        }

        function clearForm() {
            txtAge.value = "";
            txtName.value = "";
            txtMobile.value = "";
            txtEmail.value = "";
            txtDate.value = "";
            txtTime.value = "";
            cmbDoctor.value = null;

            btnAdd.removeAttribute("disabled");
            txtAge.style.backgroundColor = Initial;
            txtName.style.backgroundColor = Initial;
            txtMobile.style.backgroundColor = Initial;
            txtEmail.style.backgroundColor = Initial;
            txtDate.style.backgroundColor = Initial;
            txtTime.style.backgroundColor = Initial;
            cmbDoctor.style.backgroundColor = Initial;

        }

        function txtNameKU() {
            let name = txtName.value;
            let namePattern = new RegExp("^[A-Z][a-z]{2,}$");
            if (!namePattern.test(name)) {
                txtName.style.backgroundColor = Invalid;
                nameValidation = false;
            } else {

                txtName.style.backgroundColor = Valid;
                nameValidation = true;

            }
        }

        function txtMobileKU() {
            let mobile = txtMobile.value;
            let mobilePattern = new RegExp("^07[0-9][0-9]{7}$");
            console.log(mobilePattern.test(mobile));
            if (!mobilePattern.test(mobile)) {
                txtMobile.style.backgroundColor = Invalid;
                mobileValidation = false;
            } else {

                txtMobile.style.backgroundColor = Valid;
                mobileValidation = true;
            }
        }

        function txtEmailKU() {
            let email = txtEmail.value;
            let emailPattern = new RegExp("^[a-z0-9]+[@][a-z]+.[a-z]+$");

            if (!emailPattern.test(email)) {
                txtEmail.style.backgroundColor = Invalid;
                emailValidation = false;
            } else {

                    txtEmail.style.backgroundColor = Valid;
                    emailValidation = true;

            }
        }



        function txtTimeKU() {
            // let email = txtEmail.value;
            // // let emailPattern = new RegExp("^[a-z0-9]+[@][a-z]+.[a-z]+$");
            //
            // if (!emailPattern.test(email)) {
            //     txtEmail.style.backgroundColor = Invalid;
            //     timeValidation = false;
            // } else {
            //
            //         txtEmail.style.backgroundColor = Valid;
            //         timeValidation = true;
            //
            // }
        }



        function cmbDoctorCH() {
            let doctor = JSON.parse(cmbDoctor.value);

            if (doctor == null) {
                cmbDoctor.style.backgroundColor = Invalid;
                doctorValidation = false;
            } else {

                    cmbDoctor.style.backgroundColor = Valid;
                    doctorValidation = true;


            }

        }

        // function genarateTime(){
        //
        //     // for (let i = 0; i < time.length ; i++) {
        //         setTime(1);
        //     // }
        //
        //     // x= Number.parseInt( cmbDoctor.value);
        //     // setTime(x);
        //     // y= x+1;
        //     // cmbDoctor.value = y;
        // }


        // function setTime(i){
        //
        //
        //   return  time[i];
        //
        // }

        // function loadTime(){
        //     for ( h = 8; h < 18; h++) {
        //         for ( m = 0; m<60; m+=10) {
        //             if (h>=13) {
        //                 time.push("p.m "+ h+":"+m)
        //             }else{
        //                 time.push("a.m "+ h+":"+m)
        //             }
        //         }
        //     }
        // }





        function getErrors() {
            let errors = "";
            if (!nameValidation) errors += "\nInvalid Name";
            if (!mobileValidation) errors += "\nInvalid Mobile";
            if (!emailValidation) errors += "\nInvalid Email";
            if (!dateValidation) errors += "\nInvalid Date";
            if (!timeValidation) errors += "\nInvalid Time";
            if (!doctorValidation) errors += "\nInvalid Doctor";

            return errors;
        }

       function Add() {
            let errors = getErrors();

            if (errors !== "") {
                window.alert("You have following errors\n" + errors);
            } else {

                let appointment = new Appointment();
                appointment.name = txtName.value;
                appointment.mobile = txtMobile.value;
                appointment.email = txtEmail.value;
                appointment.date = txtDate.value;
                // appointment.time = genarateTime();
                appointment.doctor = JSON.parse(cmbDoctor.value);

                let userConfirm = window.confirm("Are you sure you want to add this record? \n" + "Name : " + appointment.name + "\nMobile : " + appointment.mobile + "\nEmail : " + appointment.email  +  "\nDate : " + appointment.date + "\nTime : " + appointment.time    + "\nDoctor : " + appointment.doctor.name);
                if (userConfirm) {

                    let result = post("appointmentcontroller.php", "appointment=" + JSON.stringify(appointment));
                    if (result !=="") {
                        window.alert(result);
                    } else {
                        window.alert("Success ..!");
                        clearForm();

                    }


                }
            }
        }








        function fillForm(data) {

            cmbDoctor.value = JSON.stringify(data.doctor);

        }

        function FillCombo(data, combo) {
            var optionHint = document.createElement("option");
            optionHint.innerHTML = "select a doctor";
            optionHint.value = null;
            optionHint.setAttribute("disabled", "disabled");
            optionHint.setAttribute("selected", "selected");
            combo.appendChild(optionHint);

            for (let i = 0; i < data.length; i++) {
                const datum = data[i];
                var option = document.createElement("option");
                option.innerHTML = datum.name;
                option.value = JSON.stringify(datum);
                combo.appendChild(option);

            }
        }



        function post(url, querry1) {
            var url = baseurl + url;
            var http = new XMLHttpRequest();
            http.open("POST", url, false);
            http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            http.send(querry1);
            if (http.status == 200) {
                return http.responseText;
            }
            return null;

        }

        function get(url) {
            var url = baseurl + url;
            var http = new XMLHttpRequest();
            http.open("GET", url, false);
            http.send();
            var data = JSON.parse(http.responseText);
            return data;
        }

    </script>
</head>
<body>
<div class="container-fluid">
    <div class="card">
        <div class="card-header bg-primary">
            <h1>Appointment Detail Manager</h1>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-info">
                            <h3>Appointment Form</h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <form action="" class="" onsubmit="return false">
                                        <div class="form-group">
                                            <label class="col-form-label col-md-3" for="txtName">Name:</label>
                                            <input class="form-control" id="txtName" size="20" type="text"/>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-form-label col-md-3" for="txtMobile">Mobile:</label>
                                            <input class="form-control" id="txtMobile" size="20" type="text"/>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-form-label col-md-3" for="txtEmail">
                                                Email:
                                            </label>
                                            <input class="form-control" id="txtEmail" size="20" type="text"/>
                                        </div>

                                        <div class="form-group">
                                            <label class="col-form-label col-md-3" for="txtMobile">Date:</label>
                                            <input  class="form-control" id="txtDate" size="20" type="date"/>
                                        </div>

                                        <div class="form-group">
                                            <button id="btnTime" class="btn btn-success" value="0" >Time</button>
                                            <label class="col-form-label col-md-3" for="txtMobile">Wait for time</label>

                                                                                        <input  value="01:04PM" class="form-control" id="txtTime" size="20" type="time"/>
                                        </div>

                                        <div class="form-group">
                                            <label class="col-form-label col-md-3" for="cmbDoctor">
                                                Doctor:
                                            </label>
                                            <select class="form-control" id="cmbDoctor">
                                            </select>
                                        </div>
                                        <div class="text-right">

                                            <button class="btn btn-success" id="btnAdd">Add</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
</body>

</html>